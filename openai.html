<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Retro Dithering Webcam Interface</title>
  <style>
    body { margin: 0; background: #000; color: #0F0; font-family: monospace; display: flex; }
    #menu { width: 200px; padding: 10px; }
    #menu .item { margin: 8px 0; }
    #interface { position: relative; flex: 1; overflow: hidden; }
    #ditherCanvas { display: block; width: 100%; height: calc(100vh - 40px); image-rendering: pixelated; }
    #status { position: absolute; bottom: 0; left: 0; right: 0; padding: 5px; background: rgba(0,0,0,0.8); }
    .cursor { position: absolute; border: 2px solid #0F0; width: 100px; height: 80px; pointer-events: none; }
  </style>
</head>
<body>
  <div id="menu">
    <div class="item">[S] Save</div>
    <div class="item">[D] Delete</div>
    <div class="item">[C] Capture</div>
    <div class="item">[F] Filter</div>
    <div class="item">[ESC] Exit</div>
  </div>
  <div id="interface">
    <canvas id="ditherCanvas"></canvas>
    <div class="cursor" id="cursorBox"></div>
    <div id="status">CTRL+F Filter Options | CTRL+S Screenshot | CTRL+Q Quit</div>
  </div>
  <script>
  (async () => {
    const video = document.createElement('video');
    video.autoplay = true;
    video.playsInline = true;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (e) {
      console.error('Cannot access webcam', e);
      return;
    }

    const canvas = document.getElementById('ditherCanvas');
    const ctx = canvas.getContext('2d');
    const off = document.createElement('canvas');
    const offCtx = off.getContext('2d');

    function resize() {
      off.width = 320;
      off.height = 240;
      canvas.width = off.width;
      canvas.height = off.height;
    }
    resize();
    window.addEventListener('resize', resize);

    function dither(imageData) {
      const data = imageData.data;
      const w = imageData.width, h = imageData.height;
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const idx = (y * w + x) * 4;
          const gray = data[idx] * 0.3 + data[idx + 1] * 0.59 + data[idx + 2] * 0.11;
          const newVal = gray < 128 ? 0 : 255;
          const err = gray - newVal;
          data[idx] = data[idx + 1] = data[idx + 2] = newVal;
          [[1, 0, 7/16], [-1, 1, 3/16], [0, 1, 5/16], [1, 1, 1/16]].forEach(([dx, dy, f]) => {
            const xx = x + dx, yy = y + dy;
            if (xx >= 0 && xx < w && yy >= 0 && yy < h) {
              const i = (yy * w + xx) * 4;
              data[i]   = Math.min(255, Math.max(0, data[i]   + err * f));
              data[i+1] = Math.min(255, Math.max(0, data[i+1] + err * f));
              data[i+2] = Math.min(255, Math.max(0, data[i+2] + err * f));
            }
          });
        }
      }
      return imageData;
    }

    function draw() {
      offCtx.drawImage(video, 0, 0, off.width, off.height);
      let frame = offCtx.getImageData(0, 0, off.width, off.height);
      frame = dither(frame);
      ctx.putImageData(frame, 0, 0);
      requestAnimationFrame(draw);
    }
    video.addEventListener('play', draw);

    const cursor = document.getElementById('cursorBox');
    document.getElementById('interface').addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      cursor.style.left = (e.clientX - rect.left - 50) + 'px';
      cursor.style.top  = (e.clientY - rect.top - 40) + 'px';
    });
  })();
  </script>
</body>
</html>
